---
import { useStoryblokApi } from "@storyblok/astro";
import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";

const storyblokApi = useStoryblokApi();
const { data } = await storyblokApi.get("cdn/stories/home", {
	version: "draft",
});

let storyId = "";

if (Astro.locals["_storybook_preview"]) {
	// console.log(Astro.locals["_storybook_preview"], data.story);
	data.story = Astro.locals["_storybook_preview"];
	storyId = data.story.id;
}

const story = data.story;
---

<html lang='en'>
	<head>
		<script define:vars={{ storyId }}>
			if (storyId) {
				// if location.search doesn't contain _storyblok, add it
				if (!location.search.includes("_storyblok")) {
					// if it doesn't contain any query params, add _storyblok
					if (!location.search) {
						location.search = `_storyblok=${storyId}`;
					} else {
						// if it contains other query params, add _storyblok after the first one
						location.search = location.search.replace(
							"?",
							`?_storyblok=${storyId}&`
						);
					}
				}
			}
		</script>

		<script>
			(function () {
				// Intercept postMessage calls
				const originalPostMessage = window.parent.postMessage;
				const originalMessage = window.postMessage;

				window.parent.postMessage = function (message, targetOrigin) {
					console.log("index: window.parent.postMessage", message);
					originalPostMessage(message, "*");
				};

				window.postMessage = function (message, targetOrigin) {
					console.log("index: window.postMessage", message);
					originalMessage(message, "*");
				};
			})();
		</script>
		<meta charset='UTF-8' />
		<meta name='viewport' content='width=device-width' />
		<link rel='icon' type='image/x-icon' href='/favicon.ico' />
		<title>The Storyblok Astro Ultimate Tutorial: Part 1</title>

		<script>
			window.addEventListener("load", (event) => {
				// console.log("Nested-Preview iframe is fully loaded");
				// wait for 1 second
				setTimeout(() => {
					// send message to parent window
					window.parent.postMessage({ type: "iframeLoaded" }, "*");
				}, 100);
			});
		</script>
		<script>
			import { loadStoryblokBridge } from "@storyblok/js";

			console.log("Storyblok Bridge initialized");
			loadStoryblokBridge().then(() => {
				const { StoryblokBridge, location } = window;
				const storyblokInstance = new StoryblokBridge();

				storyblokInstance.on(
					[
						"published",
						"change",
						"input",
						"enterEditmode",
						"customEvent",
						"unpublished",
					],
					(event) => {
						if (!event.slugChanged) {
							console.log("storyblokIntegration", event);
							const storyblokEvent = new CustomEvent(
								"interceptedStoryblokEvent",
								{
									detail: event,
								}
							);
							window.dispatchEvent(storyblokEvent);
						}
					}
				);
			});
		</script>
	</head>
	<body class='container mx-auto'>
		<StoryblokComponent blok={story.content} />
	</body>
</html>
